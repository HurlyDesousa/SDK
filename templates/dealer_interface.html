<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealer Status - Leverex</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            height: 600px;
            transition: transform 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-5px);
        }
        
        .chart-container h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        #trade-history-container {
            width: 100%;
            height: 550px;
            overflow-y: auto;
        }
        
        .trade-history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        .trade-history-table thead {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }
        
        .trade-history-table th {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
        
        .trade-history-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
        }
        
        .trade-history-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        
        .trade-history-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .trade-side-buy {
            color: #10b981;
            font-weight: 600;
        }
        
        .trade-side-sell {
            color: #ef4444;
            font-weight: 600;
        }
        
        .trade-type-maker {
            color: #3b82f6;
        }
        
        .trade-type-taker {
            color: #f59e0b;
        }
        
        .trade-pnl-positive {
            color: #10b981;
            font-weight: 600;
        }
        
        .trade-pnl-negative {
            color: #ef4444;
            font-weight: 600;
        }
        
        .trade-pnl-zero {
            color: #666;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: 600;
            color: #555;
        }
        
        .status-value {
            font-weight: 700;
        }
        
        .status-connected {
            color: #10b981;
        }
        
        .status-disconnected {
            color: #ef4444;
        }
        
        .status-ready {
            color: #10b981;
        }
        
        .status-not-ready {
            color: #f59e0b;
        }
        
        .control-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .control-button:active {
            transform: translateY(0);
        }
        
        .control-button.stopped {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .price-display-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .price-display {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }
        
        #leverex-price-display {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        #bitmex-price-display {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .price-label {
            font-size: 0.5em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .offers-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .offers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .offers-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .offers-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .offers-table tr:hover {
            background: #f5f5f5;
        }
        
        .bids-table .price {
            color: #10b981;
            font-weight: 600;
        }
        
        .asks-table .price {
            color: #ef4444;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: white;
        }
        
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 400px;
            }
            
            #btc-chart {
                height: 350px;
            }
        }
        
        @media (max-width: 768px) {
            .offers-section {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Left side: Trade History and Order Book -->
        <div class="left-column">
            <!-- Leverex Trade History -->
            <div class="chart-container">
                <h2>üìä Leverex Trade History</h2>
                <div id="trade-history-container" style="width: 100%; height: 550px; overflow-y: auto;">
                    <table class="trade-history-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Side</th>
                                <th>Type</th>
                                <th>Price</th>
                                <th>Volume</th>
                                <th>P&L</th>
                                <th>Fee</th>
                            </tr>
                        </thead>
                        <tbody id="trade-history-body">
                            <tr><td colspan="7" style="text-align: center; padding: 20px;">Loading trade history...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Leverex Order Book -->
            <div class="card">
                <h2>üí∞ Leverex Order Book</h2>
                <div class="offers-section">
                    <div>
                        <h3 style="color: #10b981; margin-bottom: 10px;">Bids (Buy Orders)</h3>
                        <table class="offers-table bids-table">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Volume</th>
                                </tr>
                            </thead>
                            <tbody id="bids-body">
                                <tr><td colspan="2" style="text-align: center; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h3 style="color: #ef4444; margin-bottom: 10px;">Asks (Sell Orders)</h3>
                        <table class="offers-table asks-table">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Volume</th>
                                </tr>
                            </thead>
                            <tbody id="asks-body">
                                <tr><td colspan="2" style="text-align: center; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right side: Dealer Status -->
        <div class="container">
            <div id="error-container"></div>
        
        <div class="price-display-container">
            <div class="price-display" id="leverex-price-display">
                <div class="price-label">Leverex Price</div>
                <div id="leverex-price">--</div>
            </div>
            <div class="price-display" id="bitmex-price-display">
                <div class="price-label">BitMEX Price</div>
                <div id="bitmex-price">--</div>
            </div>
        </div>
        
        <div class="status-grid">
            <div class="card">
                <h2>üéÆ Dealer Control</h2>
                <div style="text-align: center; padding: 20px;">
                    <button id="dealer-control-btn" class="control-button stopped" onclick="toggleDealer()">
                        <span id="control-btn-text">Start Dealer</span>
                    </button>
                    <div style="margin-top: 15px;">
                        <span class="status-label">Status:</span>
                        <span class="status-value status-disconnected" id="dealer-running-status">Stopped</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üîê Authentication Status</h2>
                <div class="status-item">
                    <span class="status-label">Leverex Connection:</span>
                    <span class="status-value" id="maker-auth">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Leverex Ready:</span>
                    <span class="status-value" id="maker-ready">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">BitMEX Connection:</span>
                    <span class="status-value" id="taker-auth">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">BitMEX Ready:</span>
                    <span class="status-value" id="taker-ready">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Dealer Ready:</span>
                    <span class="status-value" id="dealer-ready">--</span>
                </div>
            </div>
            
            <div class="card">
                <h2>üìä Status Details</h2>
                <div class="status-item">
                    <span class="status-label">Leverex Status:</span>
                    <span class="status-value" id="maker-status">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">BitMEX Status:</span>
                    <span class="status-value" id="taker-status">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Dealer Status:</span>
                    <span class="status-value" id="dealer-status">--</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Session Open Price:</span>
                    <span class="status-value" id="session-price">--</span>
                </div>
            </div>
        </div>
        
        <!-- Open Positions Section -->
        <div class="card" style="grid-column: 1 / -1; margin-top: 20px;">
            <h2>üìà Open Positions</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <!-- Leverex Positions -->
                <div>
                    <h3 style="color: #10b981; margin-bottom: 10px; font-size: 1.2em;">Leverex Positions</h3>
                    <div style="margin-bottom: 10px;">
                        <span style="font-weight: 600;">Net Exposure: </span>
                        <span id="leverex-exposure" style="font-weight: 700;">--</span>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="offers-table" style="font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th>Side</th>
                                    <th>Type</th>
                                    <th>Volume</th>
                                    <th>Price</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="leverex-positions-body">
                                <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- BitMEX Positions -->
                <div>
                    <h3 style="color: #3b82f6; margin-bottom: 10px; font-size: 1.2em;">BitMEX Positions</h3>
                    <div style="margin-bottom: 10px;">
                        <span style="font-weight: 600;">Net Exposure: </span>
                        <span id="bitmex-exposure" style="font-weight: 700;">--</span>
                        <span style="font-weight: 600; color: #666; margin-left: 5px;">XBT</span>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table class="offers-table" style="font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th>Side</th>
                                    <th>Volume</th>
                                    <th>Entry</th>
                                    <th>Leverage</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="bitmex-positions-body">
                                <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
                <div style="text-align: center;">
                    <span style="font-weight: 600; font-size: 1.1em;">Total Net Exposure: </span>
                    <span id="total-exposure" style="font-weight: 700; font-size: 1.2em; color: #667eea;">--</span>
                </div>
            </div>
        </div>
        </div>
    </div>
    
        <script>
        // Leverex Trade History Functions
        function formatTimestamp(timestamp) {
            if (!timestamp || timestamp === 0) return '--';
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function formatPrice(price) {
            if (!price || price === 0) return '--';
            return price.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function formatVolume(volume) {
            if (!volume || volume === 0) return '--';
            const absVol = Math.abs(volume);
            const sign = volume < 0 ? '-' : '';
            return sign + absVol.toLocaleString('en-US', {
                minimumFractionDigits: 8,
                maximumFractionDigits: 8
            });
        }
        
        function formatPnl(pnl) {
            if (pnl === null || pnl === undefined || pnl === 0) {
                return '<span class="trade-pnl-zero">--</span>';
            }
            const formatted = pnl.toLocaleString('en-US', {
                minimumFractionDigits: 6,
                maximumFractionDigits: 6
            });
            if (pnl > 0) {
                return '<span class="trade-pnl-positive">+' + formatted + '</span>';
            } else {
                return '<span class="trade-pnl-negative">' + formatted + '</span>';
            }
        }
        
        function updateTradeHistory(data) {
            const tbody = document.getElementById('trade-history-body');
            if (!tbody) return;
            
            if (!data.trades || data.trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No trades available</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.trades.map(trade => {
                const sideClass = trade.side === 'BUY' ? 'trade-side-buy' : 'trade-side-sell';
                const typeClass = trade.is_taker ? 'trade-type-taker' : 'trade-type-maker';
                const typeText = trade.is_taker ? 'TAKER' : 'MAKER';
                
                return `
                    <tr>
                        <td>${formatTimestamp(trade.timestamp)}</td>
                        <td class="${sideClass}">${trade.side}</td>
                        <td class="${typeClass}">${typeText}</td>
                        <td>${formatPrice(trade.price)}</td>
                        <td>${formatVolume(trade.volume)}</td>
                        <td>${formatPnl(trade.pnl)}</td>
                        <td>${formatPrice(trade.fee)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function fetchTradeHistory() {
            try {
                const response = await fetch('/api/trade-history');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updateTradeHistory(data);
            } catch (error) {
                console.error('Error fetching trade history:', error);
                const tbody = document.getElementById('trade-history-body');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #ef4444;">Error loading trade history</td></tr>';
                }
            }
        }
        
        // Fetch trade history on page load and every 5 seconds
        window.addEventListener('load', () => {
            fetchTradeHistory();
            setInterval(fetchTradeHistory, 5000);
        });
        
    </script>
    
    <script>
        function updateStatus(data) {
            // Update authentication status
            // Leverex (maker) status
            const leverexAuth = data.authentication.maker.status;
            const leverexReady = data.authentication.maker.ready;
            
            // BitMEX (taker) status
            const bitmexAuth = data.authentication.taker.status;
            const bitmexReady = data.authentication.taker.ready;
            
            const dealerReady = data.authentication.dealer.ready;
            
            // Update Leverex connection status
            document.getElementById('maker-auth').textContent = leverexAuth;
            document.getElementById('maker-auth').className = 'status-value ' + 
                (leverexAuth === 'Connected' ? 'status-connected' : 'status-disconnected');
            
            // Update BitMEX connection status
            document.getElementById('taker-auth').textContent = bitmexAuth;
            document.getElementById('taker-auth').className = 'status-value ' + 
                (bitmexAuth === 'Connected' ? 'status-connected' : 'status-disconnected');
            
            // Update Leverex ready status
            document.getElementById('maker-ready').textContent = leverexReady ? 'Ready' : 'Not Ready';
            document.getElementById('maker-ready').className = 'status-value ' + 
                (leverexReady ? 'status-ready' : 'status-not-ready');
            
            // Update BitMEX ready status
            document.getElementById('taker-ready').textContent = bitmexReady ? 'Ready' : 'Not Ready';
            document.getElementById('taker-ready').className = 'status-value ' + 
                (bitmexReady ? 'status-ready' : 'status-not-ready');
            
            document.getElementById('dealer-ready').textContent = dealerReady ? 'Ready' : 'Not Ready';
            document.getElementById('dealer-ready').className = 'status-value ' + 
                (dealerReady ? 'status-ready' : 'status-not-ready');
            
            // Update status strings
            document.getElementById('maker-status').textContent = data.authentication.maker.statusStr || 'N/A';
            document.getElementById('taker-status').textContent = data.authentication.taker.statusStr || 'N/A';
            document.getElementById('dealer-status').textContent = data.authentication.dealer.statusStr || 'N/A';
            
            // Update prices - separate sections for Leverex and BitMEX
            const leverexPrice = data.price.leverex;
            document.getElementById('leverex-price').textContent = leverexPrice ? 
                leverexPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
            
            const bitmexPrice = data.price.bitmex;
            document.getElementById('bitmex-price').textContent = bitmexPrice ? 
                bitmexPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
            
            // Trade history is updated separately via fetchTradeHistory()
            
            const sessionPrice = data.price.sessionOpen;
            document.getElementById('session-price').textContent = sessionPrice ? 
                sessionPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '--';
            
            // Update order book
            const bidsBody = document.getElementById('bids-body');
            const asksBody = document.getElementById('asks-body');
            
            if (data.offers.bids && data.offers.bids.length > 0) {
                bidsBody.innerHTML = data.offers.bids.map(bid => `
                    <tr>
                        <td class="price">${bid.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${bid.volume.toLocaleString('en-US', {minimumFractionDigits: 8, maximumFractionDigits: 8})}</td>
                    </tr>
                `).join('');
            } else {
                bidsBody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px;">No bids available</td></tr>';
            }
            
            if (data.offers.asks && data.offers.asks.length > 0) {
                asksBody.innerHTML = data.offers.asks.map(ask => `
                    <tr>
                        <td class="price">${ask.price.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${ask.volume.toLocaleString('en-US', {minimumFractionDigits: 8, maximumFractionDigits: 8})}</td>
                    </tr>
                `).join('');
            } else {
                asksBody.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px;">No asks available</td></tr>';
            }
        }
        
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">Error: ${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 5000);
        }
        
        async function toggleDealer() {
            const btn = document.getElementById('dealer-control-btn');
            const btnText = document.getElementById('control-btn-text');
            const isRunning = btnText.textContent === 'Stop Dealer';
            const action = isRunning ? 'stop' : 'start';
            
            // Disable button during request
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: action })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (action === 'stop') {
                        btnText.textContent = 'Start Dealer';
                        btn.classList.add('stopped');
                        document.getElementById('dealer-running-status').textContent = 'Stopped';
                        document.getElementById('dealer-running-status').className = 'status-value status-disconnected';
                    } else {
                        btnText.textContent = 'Stop Dealer';
                        btn.classList.remove('stopped');
                        document.getElementById('dealer-running-status').textContent = 'Running';
                        document.getElementById('dealer-running-status').className = 'status-value status-connected';
                    }
                    const actionText = action === 'start' ? 'started' : 'stopped';
                    showError(data.message || `Dealer ${actionText} successfully`);
                } else {
                    showError(data.error || `Failed to ${action} dealer`);
                }
            } catch (error) {
                console.error('Error toggling dealer:', error);
                showError(`Error: ${error.message}`);
            } finally {
                btn.disabled = false;
            }
        }
        
        async function fetchControlStatus() {
            try {
                const response = await fetch('/api/control/status');
                if (response.ok) {
                    const data = await response.json();
                    const btn = document.getElementById('dealer-control-btn');
                    const btnText = document.getElementById('control-btn-text');
                    const statusEl = document.getElementById('dealer-running-status');
                    
                    if (data.running) {
                        btnText.textContent = 'Stop Dealer';
                        btn.classList.remove('stopped');
                        statusEl.textContent = 'Running';
                        statusEl.className = 'status-value status-connected';
                    } else {
                        btnText.textContent = 'Start Dealer';
                        btn.classList.add('stopped');
                        statusEl.textContent = 'Stopped';
                        statusEl.className = 'status-value status-disconnected';
                    }
                }
            } catch (error) {
                console.error('Error fetching control status:', error);
                // Default to stopped state on error
                const btn = document.getElementById('dealer-control-btn');
                const btnText = document.getElementById('control-btn-text');
                const statusEl = document.getElementById('dealer-running-status');
                btnText.textContent = 'Start Dealer';
                btn.classList.add('stopped');
                statusEl.textContent = 'Stopped';
                statusEl.className = 'status-value status-disconnected';
            }
        }
        
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.error) {
                    showError(data.error);
                } else {
                    updateStatus(data);
                }
            } catch (error) {
                showError(error.message);
                console.error('Error fetching status:', error);
            }
        }
        
        // Fetch status immediately and then every 1 second
        fetchStatus();
        fetchControlStatus();
        setInterval(fetchStatus, 1000);
        setInterval(fetchControlStatus, 2000); // Check control status every 2 seconds
    </script>
    
    <script>
        // Positions Functions
        function formatExposure(exposure) {
            if (exposure === null || exposure === undefined || exposure === 0) return '0.00000000';
            const absExp = Math.abs(exposure);
            const sign = exposure < 0 ? '-' : '';
            return sign + absExp.toLocaleString('en-US', {
                minimumFractionDigits: 8,
                maximumFractionDigits: 8
            });
        }
        
        function updatePositions(data) {
            // Update Leverex positions
            const leverexBody = document.getElementById('leverex-positions-body');
            const leverexExposure = document.getElementById('leverex-exposure');
            
            if (leverexExposure) {
                leverexExposure.textContent = formatExposure(data.net_exposure?.leverex || 0);
            }
            
            if (leverexBody) {
                if (!data.leverex || data.leverex.length === 0) {
                    leverexBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No open positions</td></tr>';
                } else {
                    leverexBody.innerHTML = data.leverex.map(pos => {
                        const sideClass = pos.side === 'BUY' ? 'trade-side-buy' : 'trade-side-sell';
                        const typeClass = pos.type === 'TAKER' ? 'trade-type-taker' : 'trade-type-maker';
                        return `
                            <tr>
                                <td class="${sideClass}">${pos.side}</td>
                                <td class="${typeClass}">${pos.type}</td>
                                <td>${formatVolume(pos.volume)}</td>
                                <td>${formatPrice(pos.price)}</td>
                                <td>${formatPnl(pos.pnl)}</td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            // Update BitMEX positions
            const bitmexBody = document.getElementById('bitmex-positions-body');
            const bitmexExposure = document.getElementById('bitmex-exposure');
            
            if (bitmexExposure) {
                // BitMEX exposure is now in XBT
                const exposure = data.net_exposure?.bitmex || 0;
                bitmexExposure.textContent = formatExposure(exposure);
            }
            
            if (bitmexBody) {
                if (!data.bitmex || data.bitmex.length === 0) {
                    bitmexBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No open positions</td></tr>';
                } else {
                    bitmexBody.innerHTML = data.bitmex.map(pos => {
                        const sideClass = pos.side === 'LONG' ? 'trade-side-buy' : pos.side === 'SHORT' ? 'trade-side-sell' : '';
                        return `
                            <tr>
                                <td class="${sideClass}">${pos.side}</td>
                                <td>${formatVolume(pos.volume)}</td>
                                <td>${formatPrice(pos.entry_price)}</td>
                                <td>${pos.leverage}x</td>
                                <td>${formatPnl(pos.pnl)}</td>
                            </tr>
                        `;
                    }).join('');
                }
            }
            
            // Update total exposure
            const totalExposure = document.getElementById('total-exposure');
            if (totalExposure) {
                const total = data.net_exposure?.total || 0;
                totalExposure.textContent = formatExposure(total);
                // Color code based on exposure
                if (total > 0) {
                    totalExposure.style.color = '#10b981';
                } else if (total < 0) {
                    totalExposure.style.color = '#ef4444';
                } else {
                    totalExposure.style.color = '#667eea';
                }
            }
        }
        
        async function fetchPositions() {
            try {
                const response = await fetch('/api/positions');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                updatePositions(data);
            } catch (error) {
                console.error('Error fetching positions:', error);
                const leverexBody = document.getElementById('leverex-positions-body');
                const bitmexBody = document.getElementById('bitmex-positions-body');
                if (leverexBody) {
                    leverexBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #ef4444;">Error loading positions</td></tr>';
                }
                if (bitmexBody) {
                    bitmexBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #ef4444;">Error loading positions</td></tr>';
                }
            }
        }
        
        // Fetch positions on page load and every 2 seconds
        window.addEventListener('load', () => {
            fetchPositions();
            setInterval(fetchPositions, 2000);
        });
    </script>
</body>
</html>

